define([],function(){function a(a,b){b.on("update",this.update.bind(this)),this[a].push(b),this.update()}function b(a,b){var c=this[a].indexOf(b);this[a].splice(c,1),b.off("update",this.update.bind(this)),this.update()}function c(a,b){return function(c){var d=(c+b)%a;return!d}}var d=function(){return this._events={},this};d.prototype.trigger=function(a,b){var c;if(this._events[a]&&this._events[a].length)for(c=0;c<this._events[a].length;c+=1)"function"==typeof this._events[a][c]&&this._events[a][c](b)},d.prototype.on=function(a,b,c){c=c||this,b=b.bind(c),this._events[a]=this._events[a]||[],this._events[a].push(b)},d.prototype.off=function(a,b){var c=this._events[a].indexOf(b);b?this._events[a].splice(c,1):this._events[a]=[]};var e={object:function(a){function b(){}return b.prototype=a,new b},merge:function(a,b){function c(){var a;for(a in d)this[a]=d[a]}var d,e;return d={},e={},a.forEach(function(a){var c,f=new a(b);for(c in f)f.hasOwnProperty(c)?d[c]=f[c]:e[c]=a.prototype[c];e.constructor=f.constructor}),c.prototype=e,c},inherit:function(a,b,c){function d(){var a;for(a in e)this[a]=e[a]}var e,f;return e=new b(c),d.prototype=a.prototype,f=new d,a.prototype=f,a},mixin:function(a,b,c){function d(){var a;for(a in g)this[a]=g[a]}var f,g,h=function(){};return c=c||[],c instanceof Array||(c=[c]),c.forEach(function(a,b){b>0&&c[b+1]&&(c[b]=e.merge(c.slice(b)))}),b.forEach(function(a,b){h=e.inherit(h,a,c[b])}),g=a.prototype,d.prototype=h.prototype,f=new d,f.constructor=a,a.prototype=f,a},mock:function(a){a.A=function(a){return a=a||{},this.test=a.test,this},a.B=function(a){return a=a||{},this.test=!a.test,this},a.C=function(a){return this.config=a,this},a.A.prototype.isA=!0,a.B.prototype.isB=!0,a.C.prototype.isC=!0}},f=function(a){return a=a||{},this.evaluations=[],this.id=a.id,this.preparations=[],this.roles=[],this.state={},"function"==typeof a.prep&&this.preparations.push(a.prep),"function"==typeof a.evaluate&&this.evaluations.push(a.evaluate),"function"==typeof a.init&&a.init.call(this),this};f.prototype._roles={},f.prototype.role=function(a){var b,c,d;for("string"==typeof a&&(a=[a]),b=0;b<a.length;b+=1){if(d=this._roles[a[b]],!d)throw new Error('Actor role "'+a[b]+'" is not defined');this.roles.push(a[b]),d.members.push(this);for(c in d.definition)"prep"===c?this.preparations.push(d.definition[c]):"evaluate"===c?this.evaluations.push(d.definition[c]):"init"!==c&&(this[c]=d.definition[c]);"function"==typeof d.definition.init&&d.definition.init.call(this)}return this},f.prototype.set=function(a,b){return this.state[a]=b,this.trigger("update"),this},f.prototype.prep=function(){var a=this;this.preparations.forEach(function(b){b.call(a)})},f.prototype.evaluate=function(a){var b=this;return this.evaluations.map(function(c){return c.call(b,a)})},e.mixin(f,[d]);var g=function(c){var d,e;c=c||{},d=[],e=c.name||"collection",this[e]=d,this.addOne=function(b){a.call(this,e,b)},this.removeOne=function(a){b.call(this,e,a)},this.clear=function(){this[e].forEach(this.removeOne.bind(this))}};g.prototype.update=function(){return this},g.prototype.add=function(a){return Array===a.constructor?a.forEach(this.addOne.bind(this)):this.addOne(a),this},g.prototype.remove=function(a){Array===a.constructor?a.forEach(this.removeOne.bind(this)):this.removeOne(a)};var h=function(a){a=a||{},this._updating=!1,"function"==typeof a.beforeUpdate&&(this.beforeUpdate=a.beforeUpdate),"function"==typeof a.afterUpdate&&(this.afterUpdate=a.afterUpdate),a.template&&(this.template=a.template),"function"==typeof a.calculate&&(this.calculate=a.calculate),"function"==typeof a.render&&(this.render=a.render),a.element instanceof HTMLElement?this.element=a.element:a.element?this.element=document.getElementById(a.element):(this.element=document.body.appendChild(document.createElement("div")),this.element.id="pr-curtain-"+a.id),"function"==typeof a.init&&a.init.call(this)};h.prototype.beforeUpdate=function(){},h.prototype.afterUpdate=function(){},h.prototype.calculate=function(){return this},h.prototype.template=function(){return""},h.prototype.render=function(){var a=this.calculate();this.element.innerHTML=this.template(a)},h.prototype.update=function(){var a=this;return this._updating||(this._updating=!0,this.beforeUpdate(),this.render(),this.afterUpdate(),setTimeout(function(){a._updating=!1},5)),this},h.prototype.destroy=function(){this.element.parentNode.removeChild(this.element)},e.mixin(h,[g],{name:"actors"});var i=function(a,b){return a=a||{},this.id=a.id,this._frame=0,this._framerate=0,this._lastFrame=0,this._pausedAt=0,this._pausedFor=0,this.actors=[],this.conditions=[],this.curtains=[],this.paused=!1,this.running=!1,this.stages=[],this.always=a.always,this.throttle=a.throttle||60,a.curtains instanceof Array?this.curtains=a.curtains.map(function(a){return b.curtains[a]}):"string"==typeof a.curtains&&this.curtains.push(b.curtains[name]),a.stages instanceof Array?this.stages=a.stages.map(function(a){return b.stages[a]}):"string"==typeof a.curtains&&this.stages.push(b.stages[name]),"function"==typeof a.prep&&(this.prep=a.prep.bind(this)),"function"==typeof a.clear&&(this.clear=a.clear.bind(this)),"function"==typeof a.init&&a.init.call(this),this};i.prototype.warmup=function(a){return"function"==typeof this.prep&&this.prep(a),this.curtains.forEach(function(a){a.clear()}),this.stages.forEach(function(b){"function"==typeof b.prep&&b.prep(a)}),this.actors.forEach(function(b){"function"==typeof b.prep&&b.prep(a)}),this},i.prototype.evaluate=function(a){var b,c;b=[],this._frame+=1,c=this._frame,"function"==typeof this.always&&this.always(a),this.actors.forEach(function(c){var d;"function"==typeof c.evaluate&&(d=c.evaluate(a),"function"==typeof d?b.push(d):d instanceof Array&&(b=b.concat(d)))}),b.forEach(function(a){a()}),this.stages.forEach(function(b){"function"==typeof b.evaluate&&("function"!=typeof b.phase||b.phase(c))&&b.evaluate(a)}),this.conditions.forEach(function(a){a.test()&&a.run()})},i.prototype.pause=function(){return this.paused||(this.paused=!0,this._pausedAt=(new Date).getTime()),this},i.prototype.unpause=function(){return this.paused&&(this.paused=!1,this._pausedFor+=(new Date).getTime()-this._pausedAt),this},i.prototype.run=function(){var a,b,c;return b=(new Date).getTime(),c=1e3/this.throttle,a=b-this._lastFrame,this._lastFrame=b,this.paused||(this.evaluate(a),b=(new Date).getTime(),a=b-this._lastFrame,c>a?(c-=a,this._framerate=this.throttle):(c=a%c,this._framerate=Math.floor(1e3/Math.max(a,1)))),this.running&&(this._timeout=setTimeout(this.run.bind(this),c)),this},i.prototype.cleanup=function(){var a=this;return this.curtains.forEach(function(b){b.clear(a)}),this.stages.forEach(function(b){b.clear(a)}),"function"==typeof this.clear&&this.clear(),this},i.prototype.begin=function(a){this.running=!0,this._lastFrame=(new Date).getTime(),this.warmup(a),this.run()},i.prototype.end=function(){this.running=!1,clearTimeout(this._timeout),this.cleanup()};var j=function(a){a=a||{},this.id=a.id,a.interval>1&&(this.phase=c(a.interval,a.offset)),"function"==typeof a.prep&&(this.prep=a.prep.bind(this)),"function"==typeof a.evaluate&&(this.evaluate=a.evaluate.bind(this)),"function"==typeof a.clear&&(this.clear=a.clear.bind(this)),"function"==typeof a.init&&a.init.call(this)};j.prototype.clear=function(){};var k={actors:{},_actors:0,curtains:{},_curtains:0,scenes:{},_scenes:0,stages:{},_stages:0,roles:f.prototype._roles,create:function(a,b,c,d){d=d||"string"!=typeof c&&c,c=c||b+"-"+this["_"+b],d.id=d.id||c;var e=new a(d,this);return this[b][c]=e,this["_"+b]+=1,e},destroy:function(){},actor:function(a,b){return b=b||{},this.create(f,"actors",a,b)},curtain:function(a,b){return b=b||{},this.create(h,"curtains",a,b)},role:function(a,b){f.prototype._roles[a]={definition:b,members:[]}},scene:function(a,b){return b=b||{},this.create(i,"scenes",a,b)},stage:function(a,b){return b=b||{},this.create(j,"stages",a,b)}};return k});